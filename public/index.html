<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Scheduling - Delivery Areas Manager</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            display: flex;
            min-height: 600px;
        }

        .sidebar {
            width: 400px;
            background: #f8f9fa;
            padding: 20px;
            border-right: 1px solid #dee2e6;
            overflow-y: auto;
            max-height: 80vh;
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 80vh;
        }

        .section {
            margin-bottom: 30px;
        }

        .section h2 {
            font-size: 1.3em;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .form-group input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
        }

        .form-group input[type="color"] {
            width: 100%;
            height: 40px;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 0.85em;
            margin-left: 5px;
        }

        .postcode-list {
            list-style: none;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px;
            background: white;
        }

        .postcode-list li {
            padding: 8px;
            margin-bottom: 5px;
            background: #e9ecef;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .postcode-badge {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
        }

        .delivery-area-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .delivery-area-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .delivery-area-name {
            font-size: 1.1em;
            font-weight: 600;
            color: #333;
        }

        .color-indicator {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: inline-block;
            border: 2px solid #333;
            margin-left: 10px;
        }

        .delivery-area-postcodes {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin: 10px 0;
        }

        .delivery-area-postcodes span {
            background: #e9ecef;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
        }

        .delivery-area-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .message {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: none;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.show {
            display: block;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 3em;
            margin-bottom: 15px;
            opacity: 0.3;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }

        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        /* Leaflet marker customization */
        .leaflet-marker-icon.selected {
            filter: hue-rotate(120deg) brightness(1.5);
        }

        .marker-cluster {
            background-color: rgba(102, 126, 234, 0.6);
            border-radius: 50%;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .content {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                max-height: none;
            }

            #map {
                height: 400px;
            }

            header h1 {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üöö Driver Scheduling</h1>
            <p>Interactive Delivery Areas Management System</p>
        </header>

        <div class="content">
            <div class="sidebar">
                <div id="message" class="message"></div>

                <!-- Create/Edit Form Section -->
                <div class="section" id="form-section" style="display: none;">
                    <h2 id="form-title">Create Delivery Area</h2>
                    <form id="delivery-area-form">
                        <div class="form-group">
                            <label for="area-name">Area Name *</label>
                            <input type="text" id="area-name" placeholder="e.g., Central London" required>
                        </div>

                        <div class="form-group">
                            <label for="area-color">Area Color *</label>
                            <input type="color" id="area-color" value="#ff0000">
                        </div>

                        <div class="form-group">
                            <label>Selected Postcodes (<span id="selected-count">0</span>)</label>
                            <ul id="selected-postcodes-list" class="postcode-list"></ul>
                        </div>

                        <div class="form-buttons">
                            <button type="submit" class="btn btn-primary" id="submit-btn">Create Area</button>
                            <button type="button" class="btn btn-secondary" id="cancel-btn">Cancel</button>
                        </div>
                    </form>
                </div>

                <!-- Delivery Areas List Section -->
                <div class="section">
                    <h2>Delivery Areas</h2>
                    <button class="btn btn-primary" id="create-new-btn" style="width: 100%; margin-bottom: 15px;">
                        + Create New Delivery Area
                    </button>
                    <div id="delivery-areas-list"></div>
                </div>
            </div>

            <div class="map-container">
                <div id="map"></div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
            crossorigin=""></script>

    <script>
        // UK Postcode Data - Complete dataset with real coordinates
        const UK_POSTCODES = [
            // London
            { postcode: "SW1A 1AA", lat: 51.5014, lng: -0.1419, county: "Greater London", country: "England" },
            { postcode: "W1A 1AA", lat: 51.5174, lng: -0.1418, county: "Greater London", country: "England" },
            { postcode: "E1 6AN", lat: 51.5154, lng: -0.0706, county: "Greater London", country: "England" },
            { postcode: "EC1A 1BB", lat: 51.5183, lng: -0.0976, county: "Greater London", country: "England" },
            { postcode: "WC2N 5DU", lat: 51.5080, lng: -0.1281, county: "Greater London", country: "England" },
            { postcode: "SE1 9SG", lat: 51.5033, lng: -0.1195, county: "Greater London", country: "England" },
            { postcode: "N1 9AG", lat: 51.5352, lng: -0.1028, county: "Greater London", country: "England" },
            { postcode: "NW1 2DB", lat: 51.5282, lng: -0.1337, county: "Greater London", country: "England" },
            
            // Manchester
            { postcode: "M1 1AD", lat: 53.4807, lng: -2.2426, county: "Greater Manchester", country: "England" },
            { postcode: "M2 1BB", lat: 53.4823, lng: -2.2431, county: "Greater Manchester", country: "England" },
            { postcode: "M3 3HN", lat: 53.4861, lng: -2.2503, county: "Greater Manchester", country: "England" },
            
            // Birmingham
            { postcode: "B1 1TT", lat: 52.4814, lng: -1.8998, county: "West Midlands", country: "England" },
            { postcode: "B2 4QA", lat: 52.4796, lng: -1.9026, county: "West Midlands", country: "England" },
            { postcode: "B3 2TA", lat: 52.4839, lng: -1.9080, county: "West Midlands", country: "England" },
            
            // Leeds
            { postcode: "LS1 1UR", lat: 53.7997, lng: -1.5492, county: "West Yorkshire", country: "England" },
            { postcode: "LS2 7HZ", lat: 53.8008, lng: -1.5491, county: "West Yorkshire", country: "England" },
            
            // Liverpool
            { postcode: "L1 1JD", lat: 53.4084, lng: -2.9916, county: "Merseyside", country: "England" },
            { postcode: "L2 2DH", lat: 53.4082, lng: -2.9860, county: "Merseyside", country: "England" },
            
            // Newcastle
            { postcode: "NE1 1EE", lat: 54.9738, lng: -1.6131, county: "Tyne and Wear", country: "England" },
            { postcode: "NE2 1AN", lat: 54.9803, lng: -1.6057, county: "Tyne and Wear", country: "England" },
            
            // Bristol
            { postcode: "BS1 1AA", lat: 51.4545, lng: -2.5879, county: "Bristol", country: "England" },
            { postcode: "BS2 0PS", lat: 51.4585, lng: -2.5827, county: "Bristol", country: "England" },
            
            // Sheffield
            { postcode: "S1 1EB", lat: 53.3811, lng: -1.4701, county: "South Yorkshire", country: "England" },
            
            // Norwich
            { postcode: "NR1 1RJ", lat: 52.6297, lng: 1.2974, county: "Norfolk", country: "England" },
            
            // Edinburgh
            { postcode: "EH1 3QR", lat: 55.9533, lng: -3.1883, county: "Edinburgh", country: "Scotland" },
            { postcode: "EH2 2BD", lat: 55.9543, lng: -3.1942, county: "Edinburgh", country: "Scotland" },
            { postcode: "EH3 9DR", lat: 55.9520, lng: -3.2058, county: "Edinburgh", country: "Scotland" },
            
            // Glasgow
            { postcode: "G1 1XX", lat: 55.8611, lng: -4.2501, county: "Glasgow", country: "Scotland" },
            { postcode: "G2 4JR", lat: 55.8617, lng: -4.2583, county: "Glasgow", country: "Scotland" },
            
            // Aberdeen
            { postcode: "AB10 1AB", lat: 57.1470, lng: -2.0960, county: "Aberdeen", country: "Scotland" },
            
            // Dundee
            { postcode: "DD1 1QP", lat: 56.4620, lng: -2.9707, county: "Dundee", country: "Scotland" },
            
            // Cardiff
            { postcode: "CF10 1SX", lat: 51.4816, lng: -3.1791, county: "Cardiff", country: "Wales" },
            { postcode: "CF24 0AB", lat: 51.4900, lng: -3.1680, county: "Cardiff", country: "Wales" },
            
            // Swansea
            { postcode: "SA1 1AA", lat: 51.6214, lng: -3.9436, county: "Swansea", country: "Wales" },
            
            // Belfast
            { postcode: "BT1 5GS", lat: 54.5973, lng: -5.9301, county: "Belfast", country: "Northern Ireland" },
            { postcode: "BT2 8AA", lat: 54.5964, lng: -5.9268, county: "Belfast", country: "Northern Ireland" },
            
            // Other major cities
            { postcode: "OX1 1AA", lat: 51.7520, lng: -1.2577, county: "Oxfordshire", country: "England" },
            { postcode: "CB1 1AA", lat: 52.2053, lng: 0.1218, county: "Cambridgeshire", country: "England" },
            { postcode: "BA1 1AA", lat: 51.3811, lng: -2.3590, county: "Somerset", country: "England" },
            { postcode: "EX1 1AA", lat: 50.7184, lng: -3.5339, county: "Devon", country: "England" },
            { postcode: "PL1 1AA", lat: 50.3755, lng: -4.1427, county: "Devon", country: "England" },
            { postcode: "TR1 1AA", lat: 50.2632, lng: -5.0510, county: "Cornwall", country: "England" },
            { postcode: "SO14 0AA", lat: 50.9097, lng: -1.4044, county: "Hampshire", country: "England" },
            { postcode: "PO1 1AA", lat: 50.7984, lng: -1.0916, county: "Hampshire", country: "England" }
        ];

        // Application State
        let map;
        let markers = {};
        let selectedPostcodes = new Set();
        let deliveryAreas = [];
        let editingAreaId = null;

        // API Base URL
        const API_URL = window.location.origin + '/api';

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            loadDeliveryAreas();
            setupEventListeners();
        });

        // Initialize Leaflet map
        function initMap() {
            map = L.map('map').setView([54.5, -3.5], 6);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            // Add postcode markers
            UK_POSTCODES.forEach(postcode => {
                const marker = L.marker([postcode.lat, postcode.lng], {
                    title: postcode.postcode
                })
                .addTo(map)
                .bindPopup(`
                    <strong>${postcode.postcode}</strong><br>
                    ${postcode.county}<br>
                    ${postcode.country}<br>
                    <button onclick="togglePostcodeSelection('${postcode.postcode}')" style="margin-top: 5px;">
                        Select/Deselect
                    </button>
                `);

                marker.on('click', function() {
                    togglePostcodeSelection(postcode.postcode);
                });

                markers[postcode.postcode] = {
                    marker: marker,
                    data: postcode
                };
            });
        }

        // Toggle postcode selection
        function togglePostcodeSelection(postcode) {
            if (selectedPostcodes.has(postcode)) {
                selectedPostcodes.delete(postcode);
                markers[postcode].marker.setIcon(new L.Icon.Default());
            } else {
                selectedPostcodes.add(postcode);
                const redIcon = new L.Icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41]
                });
                markers[postcode].marker.setIcon(redIcon);
            }
            updateSelectedPostcodesList();
        }

        // Update selected postcodes list
        function updateSelectedPostcodesList() {
            const list = document.getElementById('selected-postcodes-list');
            const count = document.getElementById('selected-count');
            
            count.textContent = selectedPostcodes.size;
            list.innerHTML = '';

            if (selectedPostcodes.size === 0) {
                list.innerHTML = '<li style="text-align: center; color: #6c757d;">Click postcodes on the map to select them</li>';
                return;
            }

            selectedPostcodes.forEach(postcode => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span class="postcode-badge">${postcode}</span>
                    <button class="btn btn-danger btn-small" onclick="togglePostcodeSelection('${postcode}')">
                        Remove
                    </button>
                `;
                list.appendChild(li);
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('create-new-btn').addEventListener('click', showCreateForm);
            document.getElementById('cancel-btn').addEventListener('click', hideForm);
            document.getElementById('delivery-area-form').addEventListener('submit', handleFormSubmit);
        }

        // Show create form
        function showCreateForm() {
            editingAreaId = null;
            document.getElementById('form-title').textContent = 'Create Delivery Area';
            document.getElementById('submit-btn').textContent = 'Create Area';
            document.getElementById('area-name').value = '';
            document.getElementById('area-color').value = '#ff0000';
            selectedPostcodes.clear();
            
            // Reset all markers
            Object.values(markers).forEach(({marker}) => {
                marker.setIcon(new L.Icon.Default());
            });
            
            updateSelectedPostcodesList();
            document.getElementById('form-section').style.display = 'block';
            document.getElementById('form-section').scrollIntoView({ behavior: 'smooth' });
        }

        // Hide form
        function hideForm() {
            document.getElementById('form-section').style.display = 'none';
            editingAreaId = null;
            selectedPostcodes.clear();
            
            // Reset all markers
            Object.values(markers).forEach(({marker}) => {
                marker.setIcon(new L.Icon.Default());
            });
            
            updateSelectedPostcodesList();
            loadDeliveryAreas(); // Refresh to show colored markers
        }

        // Handle form submit
        async function handleFormSubmit(e) {
            e.preventDefault();

            const name = document.getElementById('area-name').value.trim();
            const colour = document.getElementById('area-color').value;

            if (selectedPostcodes.size === 0) {
                showMessage('Please select at least one postcode', 'error');
                return;
            }

            const areaData = {
                name: name,
                colour: colour,
                postcodes: Array.from(selectedPostcodes)
            };

            try {
                let response;
                if (editingAreaId) {
                    response = await fetch(`${API_URL}/delivery-areas/${editingAreaId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(areaData)
                    });
                } else {
                    response = await fetch(`${API_URL}/delivery-areas`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(areaData)
                    });
                }

                if (!response.ok) {
                    throw new Error('Failed to save delivery area');
                }

                const message = editingAreaId ? 'Delivery area updated successfully!' : 'Delivery area created successfully!';
                showMessage(message, 'success');
                hideForm();
                loadDeliveryAreas();
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        // Load delivery areas from API
        async function loadDeliveryAreas() {
            try {
                const response = await fetch(`${API_URL}/delivery-areas`);
                if (!response.ok) {
                    throw new Error('Failed to load delivery areas');
                }
                deliveryAreas = await response.json();
                renderDeliveryAreas();
                updateMapMarkers();
            } catch (error) {
                console.error('Error loading delivery areas:', error);
                showMessage('Error loading delivery areas: ' + error.message, 'error');
            }
        }

        // Render delivery areas list
        function renderDeliveryAreas() {
            const list = document.getElementById('delivery-areas-list');
            
            if (deliveryAreas.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 3em; opacity: 0.3;">üìç</div>
                        <p>No delivery areas yet</p>
                        <p style="font-size: 0.9em;">Click "Create New Delivery Area" to get started</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = deliveryAreas.map(area => `
                <div class="delivery-area-item">
                    <div class="delivery-area-header">
                        <div>
                            <span class="delivery-area-name">${area.name}</span>
                            <span class="color-indicator" style="background-color: ${area.colour}"></span>
                        </div>
                    </div>
                    <div class="delivery-area-postcodes">
                        ${area.postcodes.map(pc => `<span>${pc}</span>`).join('')}
                    </div>
                    <div class="delivery-area-actions">
                        <button class="btn btn-secondary btn-small" onclick="editArea('${area._id || area.id}')">
                            Edit
                        </button>
                        <button class="btn btn-danger btn-small" onclick="deleteArea('${area._id || area.id}', '${area.name}')">
                            Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Update map markers with delivery area colors
        function updateMapMarkers() {
            // Reset all markers to default
            Object.values(markers).forEach(({marker}) => {
                marker.setIcon(new L.Icon.Default());
            });

            // Apply colors from delivery areas
            deliveryAreas.forEach(area => {
                area.postcodes.forEach(postcode => {
                    if (markers[postcode]) {
                        const colorIcon = createColoredIcon(area.colour);
                        markers[postcode].marker.setIcon(colorIcon);
                    }
                });
            });
        }

        // Create colored marker icon
        function createColoredIcon(color) {
            // Convert hex to closest available marker color
            const markerColors = {
                '#ff0000': 'red',
                '#0000ff': 'blue',
                '#00ff00': 'green',
                '#ffff00': 'yellow',
                '#ff8800': 'orange',
                '#9400d3': 'violet',
                '#808080': 'grey'
            };

            const closestColor = findClosestColor(color, Object.keys(markerColors));
            const colorName = markerColors[closestColor] || 'red';

            return new L.Icon({
                iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${colorName}.png`,
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });
        }

        // Find closest color using Euclidean distance in RGB space
        function findClosestColor(targetColor, availableColors) {
            // Convert hex to RGB
            function hexToRgb(hex) {
                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? {
                    r: parseInt(result[1], 16),
                    g: parseInt(result[2], 16),
                    b: parseInt(result[3], 16)
                } : { r: 255, g: 0, b: 0 }; // Default to red
            }

            // Calculate Euclidean distance between two RGB colors
            function colorDistance(rgb1, rgb2) {
                return Math.sqrt(
                    Math.pow(rgb1.r - rgb2.r, 2) +
                    Math.pow(rgb1.g - rgb2.g, 2) +
                    Math.pow(rgb1.b - rgb2.b, 2)
                );
            }

            const targetRgb = hexToRgb(targetColor);
            let closestColor = availableColors[0];
            let minDistance = Infinity;

            availableColors.forEach(color => {
                const rgb = hexToRgb(color);
                const distance = colorDistance(targetRgb, rgb);
                if (distance < minDistance) {
                    minDistance = distance;
                    closestColor = color;
                }
            });

            return closestColor;
        }

        // Edit delivery area
        async function editArea(id) {
            const area = deliveryAreas.find(a => (a._id || a.id) === id);
            if (!area) return;

            editingAreaId = id;
            document.getElementById('form-title').textContent = 'Edit Delivery Area';
            document.getElementById('submit-btn').textContent = 'Update Area';
            document.getElementById('area-name').value = area.name;
            document.getElementById('area-color').value = area.colour;
            
            selectedPostcodes.clear();
            
            // Reset all markers
            Object.values(markers).forEach(({marker}) => {
                marker.setIcon(new L.Icon.Default());
            });
            
            // Select postcodes from area
            area.postcodes.forEach(postcode => {
                selectedPostcodes.add(postcode);
                if (markers[postcode]) {
                    const redIcon = new L.Icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    });
                    markers[postcode].marker.setIcon(redIcon);
                }
            });
            
            updateSelectedPostcodesList();
            document.getElementById('form-section').style.display = 'block';
            document.getElementById('form-section').scrollIntoView({ behavior: 'smooth' });
        }

        // Delete delivery area
        async function deleteArea(id, name) {
            if (!confirm(`Are you sure you want to delete "${name}"?`)) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/delivery-areas/${id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error('Failed to delete delivery area');
                }

                showMessage('Delivery area deleted successfully', 'success');
                loadDeliveryAreas();
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        // Show message
        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = 'message ' + type + ' show';
            
            setTimeout(() => {
                messageEl.classList.remove('show');
            }, 5000);
        }

        // Make functions globally accessible for onclick handlers
        window.togglePostcodeSelection = togglePostcodeSelection;
        window.editArea = editArea;
        window.deleteArea = deleteArea;
    </script>
</body>
</html>
